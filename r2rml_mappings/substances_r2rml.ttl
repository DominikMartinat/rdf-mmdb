@prefix sio: <http://semanticscience.org/resource/> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix obo: <http://purl.obolibrary.org/obo/> .
@prefix bao: <http://www.bioassayontology.org/bao#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix mmdbvoc: <https://rdf.molmedb.upol.cz/vocabulary#> .

################################################
## substance central node
################################################
<Substances#TriplesMap1>
  rr:logicalTable [ rr:sqlQuery """
    SELECT id,identifier,
      (CASE WHEN molecular_weight IS NULL THEN NULL ELSE identifier END) MW_id,
      (CASE WHEN logp IS NULL THEN NULL ELSE identifier END) LogP_id,
      (CASE WHEN charge IS NULL THEN NULL ELSE identifier END) charge_id,
      (CASE WHEN ph_start IS NULL THEN NULL ELSE identifier END) ph_min_id,
      (CASE WHEN ph_end IS NULL THEN NULL ELSE identifier END) ph_max_id,
      (CASE WHEN inchi IS NULL THEN NULL ELSE identifier END) inchi_id 
      FROM structures
  """ ] ;
  rr:subjectMap [
    rr:template "https://identifiers.org/molmedb/{identifier}" ;
    rr:class bao:BAO_0000076 ;
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{MW_id}_Molecular_Weight" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{LogP_id}_LogP" ]
  ] ;
    rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{charge_id}_charge" ]
  ] ;
    rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{ph_min_id}_pHmin" ]
  ] ;
    rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{ph_max_id}_pHmax" ]
  ] ;
    rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{inchi_id}_InChI" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_SMILES" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_InChIKey" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_MolMeDB" ]
  ] .

#link parent molecule to child form via CHEMINF_000457 -  has normalized counterpart
<Substances#TriplesMap2>
  rr:logicalTable [ rr:sqlQuery """
    SELECT DISTINCT s_child.identifier AS child, s_parent.identifier AS parent
      FROM structures as s_child, structures as s_parent WHERE s_child.parent_id = s_parent.id
    """ ] ;
  rr:subjectMap [
    rr:template "https://identifiers.org/molmedb/{child}" ;
  ] ;
    rr:predicateObjectMap [
    rr:predicate sio:CHEMINF_000457 ;
    rr:objectMap [ rr:template "https://identifiers.org/molmedb/{parent}" ]
  ] .

#set structures without parent_id to be their own parent
#and give them CHEBI molecule type - defines molecule as uncharged entity
<Substances#TriplesMap3>
  rr:logicalTable [ rr:sqlQuery "SELECT identifier FROM structures WHERE parent_id IS NULL" ] ;
  rr:subjectMap [
    rr:template "https://identifiers.org/molmedb/{identifier}" ;
    rr:class obo:CHEBI_25367 ;
  ] ;
    rr:predicateObjectMap [
    rr:predicate sio:CHEMINF_000457 ;
    rr:objectMap [ rr:template "https://identifiers.org/molmedb/{identifier}" ]
  ] .

################################################
## identifiers and crossreferences
################################################
<Substances#TriplesMap4>
#identifiers in 'identifiers' table
#there is not system of choosing one valid identifier over the others
#use all of them for now - later we can choose
#except state = 3 (invalid)

  rr:logicalTable [ rr:sqlQuery """
    SELECT DISTINCT s.id, s.identifier, i.value, i.type, 
      CASE WHEN i.type = 1 THEN i.value ELSE NULL END molname,
      CASE WHEN i.type = 4 THEN s.identifier ELSE NULL END pubchem_id,
      CASE WHEN i.type = 5 THEN s.identifier ELSE NULL END drugbank_id,
      CASE WHEN i.type = 6 THEN s.identifier ELSE NULL END chebi_id,
      CASE WHEN i.type = 7 THEN s.identifier ELSE NULL END pdb_id,
      CASE WHEN i.type = 8 THEN s.identifier ELSE NULL END chembl_id,
      CASE WHEN i.type = 4 THEN TRIM(i.value) ELSE NULL END pubchem,
      CASE WHEN i.type = 6 THEN REPLACE(i.value,'CHEBI:','') ELSE NULL END chebi,
      CASE WHEN i.type = 7 THEN i.value ELSE NULL END pdb,
      CASE WHEN i.type = 8 THEN REPLACE(CONCAT('CHEMBL', UPPER(i.value)), 'CHEMBLCHEMBL', 'CHEMBL') ELSE NULL END chembl
      FROM structures AS s, identifiers AS i 
      WHERE i.structure_id = s.id AND i.state!=3
  """] ;
  rr:subjectMap [
    rr:template "https://identifiers.org/molmedb/{identifier}" ;
  ] ;
  rr:predicateObjectMap [
    rr:predicate rdfs:label ;
    rr:objectMap [ rr:column "molname";  rr:datatype xsd:string ] ;
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{pubchem_id}_PubChemCID" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{drugbank_id}_DrugBank" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{chebi_id}_ChEBI" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{pdb_id}_PDB" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000008 ;
    rr:objectMap [ rr:template "https://rdf.molmedb.upol.cz/substance/{chembl_id}_ChEMBL" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate skos:exactMatch ;
    rr:objectMap [ rr:template "http://purl.obolibrary.org/obo/CHEBI_{chebi}" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate skos:exactMatch ;
    rr:objectMap [ rr:template "http://rdf.ncbi.nlm.nih.gov/pubchem/compound/CID{pubchem}" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate skos:exactMatch ;
    rr:objectMap [ rr:template "http://rdf.wwpdb.org/cc/{pdb}/chem_comp/{pdb}" ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate skos:exactMatch ;
    rr:objectMap [ rr:template "http://rdf.ebi.ac.uk/resource/chembl/molecule/{chembl}" ]
  ] .


################################################
## mapping of obsolete substances
################################################
<Substances#TriplesMap5>
  rr:logicalTable [ rr:sqlQuery """
    SELECT DISTINCT s.identifier AS actual_id, sl.identifier AS obsolete_id
      FROM structure_links AS sl, structures AS s WHERE s.id=sl.structure_id
    """ ] ;
  rr:subjectMap [
    rr:template "https://identifiers.org/molmedb/{obsolete_id}" ;
    rr:class bao:BAO_0000076 ;
  ] ;
    rr:predicateObjectMap [
    rr:predicate obo:IAO_0100001 ;
    rr:objectMap [ rr:template "https://identifiers.org/molmedb/{actual_id}" ]
  ] ;
    rr:predicateObjectMap [
    rr:predicate obo:IAO_0000231 ;
    rr:objectMap [ rr:constant obo:IAO_0000227 ]
  ] .

################################################
## molecular descriptors
################################################
<Substances#TriplesMap6>
  rr:logicalTable [ rr:sqlQuery """
    SELECT id, identifier, canonical_smiles
      FROM structures WHERE canonical_smiles IS NOT NULL
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_SMILES" ;
    rr:class sio:CHEMINF_000018 ;
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "canonical_smiles" ]
  ] .

<Substances#TriplesMap7>
  rr:logicalTable [ rr:sqlQuery """
    SELECT id, identifier, inchikey 
      FROM structures WHERE inchikey IS NOT NULL
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_InChIKey" ;
    rr:class sio:CHEMINF_000059
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "inchikey" ]
  ] .

<Substances#TriplesMap8>
  rr:logicalTable [ rr:sqlQuery """
    SELECT id, identifier, molecular_weight
      FROM structures WHERE molecular_weight IS NOT NULL
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_Molecular_Weight" ;
    rr:class sio:CHEMINF_000216
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "molecular_weight"; rr:datatype xsd:float ]
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000221 ;
    rr:objectMap [ rr:constant obo:UO_0000221 ]
  ] .

<Substances#TriplesMap9>
  rr:logicalTable [ rr:sqlQuery """
    SELECT id, identifier, logp 
      FROM structures WHERE LogP IS NOT NULL
    """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_LogP" ;
    rr:class sio:CHEMINF_000251 ;
  ];
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "logp"; rr:datatype xsd:float ]
  ] .

<Substances#TriplesMap10>
  rr:logicalTable [ rr:sqlQuery "SELECT id, identifier FROM structures" ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_MolMeDB" ;
    rr:class sio:CHEMINF_000571
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "identifier" ]
  ] .

  <Substances#TriplesMap11>
  rr:logicalTable [ rr:sqlQuery """"
    SELECT id, identifier, charge 
      FROM structures WHERE charge IS NOT NULL
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_charge" ;
    rr:class sio:CHEMINF_000268 ;
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "charge"; rr:datatype xsd:integer ]
  ] .

<Substances#TriplesMap12>
  rr:logicalTable [ rr:sqlQuery """"
    SELECT id, identifier, ph_start
      FROM structures WHERE ph_start IS NOT NULL
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{ph_max_id}_pHmin" ;
    rr:class mmdbvoc:ProtonationMinPH ;
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "ph_start"; rr:datatype xsd:float ]
  ] .

<Substances#TriplesMap13>
  rr:logicalTable [ rr:sqlQuery """"
    SELECT id, identifier, ph_end
      FROM structures WHERE ph_end IS NOT NULL
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{ph_max_id}_pHmax" ;
    rr:class mmdbvoc:ProtonationMaxPH ;
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "ph_end"; rr:datatype xsd:float ]
  ] .

  <Substances#TriplesMap14>
  rr:logicalTable [ rr:sqlQuery """
    SELECT id, identifier, inchi
      FROM structures WHERE inchi IS NOT NULL
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_InChI" ;
    rr:class sio:CHEMINF_000113 ;
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "inchi" ]
  ] .


################################################
## database crossidentifiers
################################################
<Substances#TriplesMap15>
#use all except invalid (state = 3)
#to be updated when we have a better system for choosing valid identifiers
  rr:logicalTable [ rr:sqlQuery """
    SELECT DISTINCT s.identifier, TRIM(i.value) AS value
      FROM identifiers AS i, structures AS s 
      WHERE i.state = 1 AND i.structure_id = s.id AND i.type = 4 AND i.state != 3
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_PubChemCID" ;
    rr:class sio:CHEMINF_000140 ;
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "value"; rr:datatype xsd:string ]
  ] .

<Substances#TriplesMap16>
  rr:logicalTable [ rr:sqlQuery """
    SELECT DISTINCT s.identifier, i.value AS value
      FROM identifiers AS i, structures AS s 
      WHERE i.state = 1 AND i.structure_id = s.id AND i.type = 5 AND i.state != 3
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_DrugBank" ;
    rr:class sio:CHEMINF_000406
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "value" ]
  ] .

#later
<Substances#TriplesMap17>
  rr:logicalTable [ rr:sqlQuery """
    SELECT DISTINCT s.identifier, replace(i.value,'CHEBI:','') AS value
      FROM identifiers AS i, structures AS s 
      WHERE i.state = 1 AND i.structure_id = s.id AND i.type = 6 AND i.state != 3 AND i.value not like 'CHEMBL%'
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_ChEBI" ;
    rr:class sio:CHEMINF_000407
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:template "CHEBI:{value}"; rr:datatype xsd:string ]
  ] .

<Substances#TriplesMap18>
  rr:logicalTable [ rr:sqlQuery """
    SELECT DISTINCT s.identifier, i.value AS value
      FROM identifiers AS i, structures AS s 
      WHERE i.state = 1 AND i.structure_id = s.id AND i.type = 7 AND i.state != 3
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_PDB" ;
    rr:class sio:CHEMINF_000572
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "value" ]
  ] .

<Substances#TriplesMap19>
  rr:logicalTable [ rr:sqlQuery """
    SELECT DISTINCT s.identifier, REPLACE(CONCAT('CHEMBL', UPPER(i.value)), 'CHEMBLCHEMBL', 'CHEMBL') AS value
      FROM identifiers AS i, structures AS s 
      WHERE i.state = 1 AND i.structure_id = s.id AND i.type = 8 AND i.state != 3
  """ ] ;
  rr:subjectMap [
    rr:template "https://rdf.molmedb.upol.cz/substance/{identifier}_ChEMBL" ;
    rr:class sio:CHEMINF_000412
  ] ;
  rr:predicateObjectMap [
    rr:predicate sio:SIO_000300 ;
    rr:objectMap [ rr:column "value"; rr:datatype xsd:string ]
  ] .